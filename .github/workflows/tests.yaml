name: Test

on:
    pull_request:
    push:
        branches: [ master ]

# this fixes the input device is not a TTY .. see https://github.com/docker/compose/issues/5696
env:
    COMPOSE_INTERACTIVE_NO_CLI: 1
    DB_HOST: 'mysql'

jobs:
    test:
        name: PHP ${{ matrix.php-version }} + ${{ matrix.dependencies }} + ${{ matrix.variant }}
        runs-on: ubuntu-18.04
        strategy:
            matrix:
                php-version:
                    - '7.4'
                    - '8.0'
                    - '8.1'
                dependencies: [ highest ]
                variant: [ normal ]
                include:
                    -   php-version: '7.4'
                        dependencies: lowest
                        variant: normal
                        composer-flags: '--prefer-lowest'
                    -   php-version: '7.4'
                        dependencies: highest
                        variant: 'symfony/symfony:"~4.4.0"'
                        composer-flags: ''
                    -   php-version: '7.4'
                        dependencies: highest
                        variant: 'symfony/symfony:"~5.3.0"'
                        composer-flags: ''
        # To keep in sync with docker-compose.yml
        services:
            mysql:
                image: mysql:8.0
                ports:
                    - 3307:3306
                env:
                    MYSQL_DATABASE: fidry_alice_data_fixtures
                    MYSQL_ROOT_USER: root
                    MYSQL_ROOT_PASSWORD: password
            mongo:
                image: mongo:4.4-bionic
                ports:
                    - 27018:27017
                env:
                    MONGO_INITDB_DATABASE: fidry_alice_data_fixtures
                    MONGO_INITDB_ROOT_USERNAME: root
                    MONGO_INITDB_ROOT_PASSWORD: password
        steps:
            -   name: Checkout
                uses: actions/checkout@v2

            -   name: Install PHP with extensions
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php-version }}
                    coverage: xdebug
                    tools: phpenv, pecl, composer:v2
                    extensions: mongodb

            -   name: Configure
                run: |
                    set -eo pipefail
                    PHPUNIT_FLAGS='--stop-on-failure --verbose'
                    perl -pi -e 's/^}$/,"provide":{"ext-mongo":"*"}}/' composer.json

            -   name: Install Composer dependencies (${{ matrix.dependencies }})
                uses: ramsey/composer-install@v1
                with:
                    dependency-versions: ${{ matrix.dependencies }}
                    composer-options: "--prefer-dist --prefer-stable"

            # Split the bin updates to avoid GA to timeout the task
            -   name: Install doctrine Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin doctrine update --prefer-dist --prefer-stable ${{ matrix.composer-flags }} && touch vendor-bin/doctrine/vendor/phpunit
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Install MongoDB Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin doctrine_mongodb update --prefer-dist --prefer-stable ${{ matrix.composer-flags }}
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Install PHPCR Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin doctrine_phpcr update --prefer-dist --prefer-stable ${{ matrix.composer-flags }}
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Install Eloquent Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin eloquent update --prefer-dist --prefer-stable ${{ matrix.composer-flags }}
                    max_attempts: 3
                    timeout_minutes: 2

            # There is a known issue here with Composer
            # see https://github.com/composer/composer/issues/10200
            # Meanwhile we break down the installation as a workaround.
            # Once this is fixed the whole bin dependencies can probably be installed
            # in one step with a timeout adjustment
            -   name: Remove Symfony from ProxyManager Composer bin dependencies
                run: composer bin proxy-manager remove --dev symfony/symfony --no-update
            -   name: Install ProxyManager Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin proxy-manager update --prefer-dist --prefer-stable ${{ matrix.composer-flags }}
                    max_attempts: 3
                    timeout_minutes: 2
            -   name: Install Symfony for ProxyManager Composer bin dependencies
                if: matrix.variant == 'normal'
                uses: nick-invision/retry@v2
                with:
                    command: composer bin proxy-manager require --dev "symfony/symfony:^4.4.32 || ^5.3.9" --prefer-dist --prefer-stable ${{ matrix.composer-flags }} --with-dependencies
                    max_attempts: 3
                    timeout_minutes: 2
            -   name: Install Symfony (variant) for ProxyManager Composer bin dependencies
                if: matrix.variant != 'normal'
                uses: nick-invision/retry@v2
                with:
                    command: composer bin proxy-manager require --dev ${{ matrix.variant }} --prefer-dist --prefer-stable ${{ matrix.composer-flags }} --with-dependencies
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Configure Symfony (variant) Composer bin dependencies
                if: matrix.variant != 'normal'
                run: composer bin symfony require --dev --no-update ${{ matrix.variant }}

            -   name: Install Symfony Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin symfony update --prefer-dist --prefer-stable ${{ matrix.composer-flags }}
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Install CoversValidator Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin covers-validator install --prefer-dist
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Install PHP-CS-Fixer Composer bin dependencies
                uses: nick-invision/retry@v2
                with:
                    command: composer bin php-cs-fixer install --prefer-dist
                    max_attempts: 3
                    timeout_minutes: 2

            -   name: Run Tests
                run: make test
                timeout-minutes: 5
